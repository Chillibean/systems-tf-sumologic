AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: "Template to setup the ECS app with AWS and Sumo Logic resources for AWS Observability Solution."

Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: "Sumo Logic Access Configuration (Required)"
        Parameters:
          - Section1aSumoDeployment
          - Section1bSumoAccessID
          - Section1cSumoAccessKey
          - Section1dRemoveSumoResourcesOnDeleteStack

      - Label:
          default: "App Details - Sumo Logic App Configuration"
        Parameters:
          - Section2aInstallApp

      - Label:
          default: "App Details - CloudTrail Log Source Configuration"
        Parameters:
          - Section3aCloudTrailLogsSourceName

      - Label:
          default: "Local Parameters. Do Not Edit the values."
        Parameters:
          - Section4aParentStackLambdaARN

    ParameterLabels:
      Section1aSumoDeployment:
        default: "Sumo Logic Deployment Name"
      Section1bSumoAccessID:
        default: "Sumo Logic Access ID"
      Section1cSumoAccessKey:
        default: "Sumo Logic Access Key"
      Section1dRemoveSumoResourcesOnDeleteStack:
        default: "Delete Sumo Logic Resources when stack is deleted"

      Section2aInstallApp:
        default: "Install Sumo Logic App"

      Section3aCloudTrailLogsSourceName:
        default: "Sumo Logic CloudTrail Logs Source Name"

      Section4aParentStackLambdaARN:
        default: "If Any, Lambda ARN from parent Stack"

Parameters:
  Section1aSumoDeployment:
    Type: String
    Default: ""
    Description: "Enter au, ca, de, eu, jp, us2, in, fed or us1."
  Section1bSumoAccessID:
    Type: String
    Description: "Sumo Logic Access ID. Used for Sumo Logic API calls."
    AllowedPattern: ".+"
    ConstraintDescription: "Sumo Logic Access ID can not be empty."
  Section1cSumoAccessKey:
    Type: String
    Description: "Sumo Logic Access Key. Used for Sumo Logic API calls."
    AllowedPattern: ".+"
    ConstraintDescription: "Sumo Logic Access Key can not be empty."
    NoEcho: true
  Section1dRemoveSumoResourcesOnDeleteStack:
    AllowedValues:
      - true
      - false
    Default: true
    Description: "To delete collectors, sources and apps when the stack is deleted, set this parameter to True. Default is True.
                  Deletes the resources created by the stack. Deletion of updated resources will be skipped."
    Type: String

  Section2aInstallApp:
    Type: String
    Description: "Yes - Installs the Amazon ECS App for the Sumo Logic AWS Observability Solution.
                  No - Skips the installation of this app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'

  Section3aCloudTrailLogsSourceName:
    Type: String
    Description: Change the CloudTrail Source name to be created else default name will be used.
    Default: ""

  Section4aParentStackLambdaARN:
    Type: String
    Default: "ParentStackLambdaARN"
    Description: Parent Stack Lambda ARN. Do Not Edit the value.

Conditions:
  install_app: !Equals [!Ref Section2aInstallApp, 'Yes']

  create_fer: !Not [!Equals [!Ref Section3aCloudTrailLogsSourceName, '']]

Resources:

  MetricRule:
    Type: Custom::SumoLogicMetricRules
    Properties:
      ServiceToken: !Ref Section4aParentStackLambdaARN
      RemoveOnDeleteStack: false
      MetricRuleName: "AwsObservabilityECSMetricsEntityRule"
      MatchExpression: "Namespace=AWS/ECS ClusterName=*"
      ExtractVariables:
        entity: "$ClusterName._1"
      SumoAccessID: !Ref Section1bSumoAccessID
      SumoAccessKey: !Ref Section1cSumoAccessKey
      SumoDeployment: !Ref Section1aSumoDeployment

  sumoApp:
    Type: Custom::App
    Condition: install_app
    Properties:
      ServiceToken: !Ref Section4aParentStackLambdaARN
      Region: !Ref "AWS::Region"
      AppName: "AWS Observability Ecs App"
      Version: "V1.0.1"
      RemoveOnDeleteStack: !Ref Section1dRemoveSumoResourcesOnDeleteStack
      FolderName: "Sumo Logic AWS Observability Apps "
      RetainOldAppOnUpdate: true
      SumoAccessID: !Ref Section1bSumoAccessID
      SumoAccessKey: !Ref Section1cSumoAccessKey
      SumoDeployment: !Ref Section1aSumoDeployment

  FieldExtractionRule:
    Type: Custom::SumoLogicFieldExtractionRule
    Condition: create_fer
    Properties:
      ServiceToken: !Ref Section4aParentStackLambdaARN
      RemoveOnDeleteStack: false
      FieldExtractionRuleName: "AwsObservabilityECSCloudTrailLogsFER"
      FieldExtractionRuleScope: !Join
        - ""
        - - "(_source="
          - !Ref Section3aCloudTrailLogsSourceName
          - " (\"ecs.amazonaws.com\"))"
      FieldExtractionRuleParseExpression: 'json "eventSource", "awsRegion", "requestParameters" as eventSource, region, requestParameters nodrop
                                           | json field=requestParameters "cluster" as clustername nodrop
                                           | where eventSource = "ecs.amazonaws.com"
                                           | "aws/ecs" as namespace
                                           | fields region, namespace, clustername'
      FieldExtractionRuleParseEnabled: true
      SumoAccessID: !Ref Section1bSumoAccessID
      SumoAccessKey: !Ref Section1cSumoAccessKey
      SumoDeployment: !Ref Section1aSumoDeployment

  AddClusterNameField:
    Type: Custom::SumoLogicFieldsSchema
    Properties:
      ServiceToken: !Ref Section4aParentStackLambdaARN
      FieldName: "clustername"
      RemoveOnDeleteStack: false
      SumoAccessID: !Ref Section1bSumoAccessID
      SumoAccessKey: !Ref Section1cSumoAccessKey
      SumoDeployment: !Ref Section1aSumoDeployment